name: Build MindTheGapps

on:
  workflow_call:
    inputs:
      BUILD_UDC:
        required: true
        type: string
      BUILD_VIC:
        required: true
        type: string
env: 
    GAPPSV: 'vic'
    GAPPSU: 'upsilon'
    REPO: 'vendor_gapps'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BUILD_UDC: ${{ inputs.BUILD_UDC }}
      BUILD_VIC: ${{ inputs.BUILD_VIC }}
    steps:
      - uses: actions/checkout@v4
      - name: Show passed environment variables
        run: |
          echo "BUILD_UDC: $BUILD_UDC"
          echo "BUILD_VIC: $BUILD_VIC"
          echo "current_date=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Build For Android 15 
        if: ${{ inputs.BUILD_VIC == '0' }}
        run: | 
          git clone https://gitlab.com/MindTheGapps/"${{ env.REPO }}" --depth=1 -b \
            "${{ env.GAPPSU }}" "${{ env.REPO }}_${{ env.GAPPSU }}"
          
          APK_PATHS=$(cat ${{ github.workspace }}/remove.list)
          
          for APK_PATH in "${APK_PATHS}"; do
          rm -f $(find . -iname "*$APK_PATH*")
          done

          cd "${{ env.REPO }}_${{ env.GAPPSU }}"
          make gapps_arm64 
          cd -

      - name: Release        
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.REPO }}_${{ env.GAPPSU }}/out/MindTheGapps-*.zip
            ${{ env.REPO }}_${{ env.GAPPSV }}/out/MindTheGapps-*.zip
          fail_on_unmatched_files: true
          append_body: false
          tag_name: MindTheGapps_${{ env.current_date }}
          name: ${{ env.ZIP_FILE_NAME }}
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### UpsideDownCake: 
            ${{ env.COMMIT_U }}

            ### VanillaIceCream: 
            ${{ env.COMMIT_V }}
